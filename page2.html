<!DOCTYPE html>
<head>
    <title>Page 2 - Population Density</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <h1>Income by State - Rural vs Urban</h1>
    <ul>
        <li>This scene labels the data points green if it is a rural state or yellow if it is a urban state.</li>
        <li>As you can see rural states have more income growth.</li>
    </ul>
    <div id="filter-container" style="position: absolute; right: 20px; top: 20px;">
        <label for="urbanRuralFilter">Filter by Area Type:</label>
        <select id="urbanRuralFilter">
          <option value="all">All</option>
          <option value="Urban">Urban</option>
          <option value="Rural">Rural</option>
        </select>
      </div>
      
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script>
        // Set dimensions and margins
        var margin = {top: 20, right: 20, bottom: 60, left: 120};
        var width = 960 - margin.left - margin.right;
        var height = 500 - margin.top - margin.bottom;

        // Append SVG object
        var svg = d3.select("body")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);

        // Tooltip
        var tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

        // Create a variable to hold the current filter value. It's initially set to "all" 
        let currentFilter = "all";

        // Get the dropdown element from the DOM
        var dropdown = document.getElementById("urbanRuralFilter");

        // Add a change event handler to the dropdown
        dropdown.addEventListener("change", function() {
            // Get the new selected option
            currentFilter = dropdown.options[dropdown.selectedIndex].value;

            // Redraw the chart
            drawChart();
        });

        // Declare incomeData and popData variables outside of Promise block to make them accessible in drawChart()
        let incomeData = null;
        let popData = null;

        // Read the data
        Promise.all([
         d3.csv("State_Income_Clean.csv"),
         d3.csv("State_Pop_Clean.csv")
        ]).then(function(files) {
           // Prepare and merge data
           incomeData = files[0];
           popData = files[1];
           let popLookup = {};

           popData.forEach(function(d) {
           popLookup[d.State] = +d['Population Density'];
           });

           incomeData.forEach(function(d) {
            d.Density = popLookup[d.State] || 0;
            d['2021 Median income'] = +d['2021 Median income'].replace(/,/g, '');
            d['YoY Growth'] = +d['YoY Growth'].replace('%', '');
            d.DensityGroup = d.Density > 113 ? 'Urban' : 'Rural';
           });

           // Call the drawChart function for the first time
           drawChart();
        });

        // Put your chart-drawing code into a function so you can call it again whenever the filter changes
        function drawChart() {
            // Clear the existing chart
            svg.selectAll("*").remove();

            // Draw the chart with the filtered data
            // Use the filter() function to filter the data based on the current value of the filter
            let filteredData = incomeData;
            if (currentFilter != "all") {
                filteredData = incomeData.filter(d => d.DensityGroup == currentFilter);
            }

            // Create color scale
            const color = d3.scaleOrdinal()
                .domain(["Urban", "Rural"])
                .range(["orange", "green"]);
                
            var highlightedStates = ["Idaho", "Montana", "Oklahoma", "Vermont", "Tennessee", "Maine", "Louisiana"];

            // Axes and scales
            const x = d3.scaleLinear().domain([d3.min(filteredData, d => d["YoY Growth"]), d3.max(filteredData, d => d["YoY Growth"])]).nice().range([0, width]);
            const y = d3.scaleLinear().domain([35000, d3.max(filteredData, d => d["2021 Median income"])]).nice().range([height, 0]);

            svg.append('g')
            .selectAll("dot")
            .data(filteredData)
            .join("circle")
            .attr("cx", function (d) { return x(d['YoY Growth']); } )
            .attr("cy", function (d) { return y(d['2021 Median income']); } )
            .attr("r", 5)
            .attr("stroke", function(d) { return highlightedStates.includes(d.State) ? "lime" : "none"; })
            .attr("stroke-width", function(d) { return highlightedStates.includes(d.State) ? 2 : 0; })
            .style("fill", function(d) { 
                if (d.DensityGroup == "Urban") { return "orange"; } 
                else if (d.DensityGroup == "Rural") { return "green"; }
            })
            .on("mouseover", function(event, d) {
                tooltip.style("visibility", "visible")
                    .html(`State: ${d.State}<br>2021 Median Income: ${d['2021 Median income']}<br>YoY Growth: ${d['YoY Growth']}<br>Population Density: ${d.Density}`);
            })
            .on("mousemove", function(event) {
                tooltip.style("top", (event.pageY-10)+"px")
                    .style("left",(event.pageX+10)+"px");
            })
            .on("mouseout", function() {
                tooltip.style("visibility", "hidden");
            });

            // Axis labels
            svg.append("text").attr("text-anchor", "end").attr("x", width).attr("y", height + margin.top + 20).text("Year-Over-Year Growth (Percentage)");
            svg.append("text").attr("text-anchor", "end").attr("transform", "rotate(-90)").attr("y", -margin.left+20).attr("x", -margin.top).text("Median Income (USD)");

            svg.append("g")
                .attr("transform", "translate(" + x(0) + ",0)")
                .call(d3.axisLeft(y));

            svg.append("g")
                .attr("transform", "translate(0," + y(35000) + ")")
                .call(d3.axisBottom(x));

            // Draw legend
            var legend = svg.selectAll(".legend")
                .data(color.domain())
                .enter().append("g")
                .attr("class", "legend")
                .attr("transform", (d, i) => `translate(0,${i * 20})`);

            // Draw legend colored rectangles
            legend.append("rect")
                .attr("x", width - 18)
                .attr("width", 18)
                .attr("height", 18)
                .style("fill", color);

            // Draw legend text
            legend.append("text")
                .attr("x", width - 24)
                .attr("y", 9)
                .attr("dy", ".35em")
                .style("text-anchor", "end")
                .text(d => d);
        }
    </script>
</body>
</html>

